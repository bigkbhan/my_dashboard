'use client';

import { useState, useEffect, useCallback } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { ChevronDown, ChevronUp, RefreshCw, MapPin, Settings, Edit, Trash2, GripVertical, X, Cloud } from 'lucide-react';
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable';
import {
  useSortable,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface WeatherData {
  time: string;
  temperature: number;
  description: string;
  icon: string;
  humidity: number;
}

interface WeatherCity {
  id: number;
  city_code: string;
  city_name: string;
  english_name: string;
  display_order: number;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}


// ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ÏùÑ ÏúÑÌïú SortableItem Ïª¥Ìè¨ÎÑåÌä∏
function SortableItem({ city, onEdit, onDelete }: { 
  city: WeatherCity; 
  onEdit: (city: WeatherCity) => void; 
  onDelete: (id: number) => void; 
}) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
  } = useSortable({ id: city.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg"
    >
      <div {...attributes} {...listeners}>
        <GripVertical size={16} className="text-slate-400 cursor-grab" />
      </div>
      <div className="flex-1">
        <div className="text-white text-sm font-medium">{city.city_name}</div>
        <div className="text-slate-400 text-xs">{city.city_code}</div>
      </div>
      <div className="flex gap-1">
        <button
          onClick={() => onEdit(city)}
          className="p-1 hover:bg-slate-600 rounded transition-colors"
          title="ÏàòÏ†ï"
        >
          <Edit size={14} className="text-slate-300" />
        </button>
        <button
          onClick={() => onDelete(city.id)}
          className="p-1 hover:bg-slate-600 rounded transition-colors"
          title="ÏÇ≠Ï†ú"
        >
          <Trash2 size={14} className="text-slate-300" />
        </button>
      </div>
    </div>
  );
}

export default function WeatherSection() {
  const [isOpen, setIsOpen] = useState(false);
  const [weatherData, setWeatherData] = useState<WeatherData[]>([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [refreshMessage, setRefreshMessage] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [selectedCity, setSelectedCity] = useState('Seoul');
  const [currentCityName, setCurrentCityName] = useState('ÏÑúÏö∏');
  const [cities, setCities] = useState<WeatherCity[]>([]);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [localCities, setLocalCities] = useState<WeatherCity[]>([]);
  const [newCity, setNewCity] = useState({ city_code: '', city_name: '', english_name: '' });
  const [editingCity, setEditingCity] = useState<WeatherCity | null>(null);

  const fetchCities = useCallback(async () => {
    try {
      const response = await fetch('/api/weather/cities');
      const data = await response.json();
      
      if (response.ok && data.cities) {
        setCities(data.cities);
      }
    } catch (error) {
      console.error('ÎèÑÏãú Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:', error);
    }
  }, []);

  const fetchWeatherData = useCallback(async (isRefresh = false) => {
    try {
      if (isRefresh) {
        setRefreshMessage('ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞Î•º Ï°∞ÌöåÌïòÎäî Ï§ë...');
        setRefreshing(true);
        setWeatherData([]);
        setError(null);
      }

      const response = await fetch(`/api/weather?city=${selectedCity}&country=KR`);
      const data = await response.json();
      
      if (!response.ok) {
        // APIÏóêÏÑú Î∞òÌôòÎêú Ïò§Î•ò Î©îÏãúÏßÄ ÏÇ¨Ïö©
        if (data.error && data.details) {
          throw new Error(`${data.error}: ${data.details}`);
        } else if (data.error) {
          throw new Error(data.error);
        } else {
          throw new Error(`ÎÇ†Ïî® API ÏùëÎãµ Ïò§Î•ò (${response.status})`);
        }
      }

             if (data.forecast && Array.isArray(data.forecast)) {
        setWeatherData(data.forecast);
        // ÏÑ†ÌÉùÎêú ÎèÑÏãúÏùò ÌïúÍ∏Ä Ïù¥Î¶Ñ Ï∞æÍ∏∞
        const selectedCityData = cities.find(city => city.city_code === selectedCity);
        setCurrentCityName(selectedCityData ? selectedCityData.city_name : selectedCity);
        setError(null);
      } else {
        throw new Error('ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®:', error);
      if (error instanceof Error) {
        setError(error.message);
      } else {
        setError('ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
      }
      setWeatherData([]);
    } finally {
      setLoading(false);
      if (isRefresh) {
        setRefreshing(false);
        setRefreshMessage(null);
      }
    }
  }, [selectedCity, cities]);

  useEffect(() => {
    // ÌéòÏù¥ÏßÄ Î°úÎìú ÏãúÏóêÎßå Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
    fetchWeatherData();
    fetchCities();
  }, []); // Îπà ÏùòÏ°¥ÏÑ± Î∞∞Ïó¥Î°ú Ï¥àÍ∏∞ Î°úÎìú ÏãúÏóêÎßå Ïã§Ìñâ

  useEffect(() => {
    // selectedCityÍ∞Ä Î≥ÄÍ≤ΩÎê† ÎïåÎßå Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (Ï¥àÍ∏∞ Î°úÎìú Ï†úÏô∏)
    if (weatherData.length > 0 && cities.length > 0) {
      fetchWeatherData();
    }
  }, [selectedCity, cities]);

  useEffect(() => {
    // cities propÍ≥º localCities state ÎèôÍ∏∞Ìôî
    setLocalCities(cities);
  }, [cities]);


  const getWeatherIcon = (iconCode: string) => {
    // OpenWeatherMap ÏïÑÏù¥ÏΩò ÏΩîÎìúÏóê Îî∞Î•∏ ÏïÑÏù¥ÏΩò Îß§Ìïë
    const iconMap: { [key: string]: string } = {
      '01d': '‚òÄÔ∏è', // ÎßëÏùå (ÎÇÆ)
      '01n': 'üåô', // ÎßëÏùå (Î∞§)
      '02d': '‚õÖ', // Íµ¨Î¶Ñ Ï°∞Í∏à (ÎÇÆ)
      '02n': '‚òÅÔ∏è', // Íµ¨Î¶Ñ Ï°∞Í∏à (Î∞§)
      '03d': '‚òÅÔ∏è', // Íµ¨Î¶Ñ ÎßéÏùå
      '03n': '‚òÅÔ∏è', // Íµ¨Î¶Ñ ÎßéÏùå
      '04d': '‚òÅÔ∏è', // ÌùêÎ¶º
      '04n': '‚òÅÔ∏è', // ÌùêÎ¶º
      '09d': 'üåßÔ∏è', // ÏÜåÎÇòÍ∏∞
      '09n': 'üåßÔ∏è', // ÏÜåÎÇòÍ∏∞
      '10d': 'üå¶Ô∏è', // ÎπÑ (ÎÇÆ)
      '10n': 'üåßÔ∏è', // ÎπÑ (Î∞§)
      '11d': '‚õàÔ∏è', // Ï≤úÎë•Î≤àÍ∞ú
      '11n': '‚õàÔ∏è', // Ï≤úÎë•Î≤àÍ∞ú
      '13d': '‚ùÑÔ∏è', // Îàà
      '13n': '‚ùÑÔ∏è', // Îàà
      '50d': 'üå´Ô∏è', // ÏïàÍ∞ú
      '50n': 'üå´Ô∏è', // ÏïàÍ∞ú
    };
    
    return iconMap[iconCode] || 'üå§Ô∏è';
  };

  const formatTime = (timeString: string) => {
    const date = new Date(timeString);
    return date.toLocaleTimeString('ko-KR', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false 
    });
  };


  const handleCityChange = (event: React.ChangeEvent<HTMLSelectElement>) => {
    const newCity = event.target.value;
    setSelectedCity(newCity);
    // ÎèÑÏãúÍ∞Ä Î≥ÄÍ≤ΩÎêòÎ©¥ ÏûêÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º ÏÉàÎ°ú Ï°∞ÌöåÌï©ÎãàÎã§
  };

  const handleDialogClose = () => {
    setIsDialogOpen(false);
    // ÏÑ§Ï†ï Ï∞ΩÏù¥ Îã´Ìûê Îïå ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
    fetchWeatherData(true);
  };

  const handleAddCity = async () => {
    if (!newCity.city_code || !newCity.city_name || !newCity.english_name) {
      alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    try {
      const response = await fetch('/api/weather/cities', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newCity)
      });

      if (response.ok) {
        const data = await response.json();
        setLocalCities([...localCities, data.city]);
        setNewCity({ city_code: '', city_name: '', english_name: '' });
        await fetchCities(); // DBÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
      }
    } catch (error) {
      console.error('ÎèÑÏãú Ï∂îÍ∞Ä Ïã§Ìå®:', error);
      alert('ÎèÑÏãú Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  const handleEditCity = (city: WeatherCity) => {
    setEditingCity(city);
    setNewCity({
      city_code: city.city_code,
      city_name: city.city_name,
      english_name: city.english_name
    });
  };

  const handleUpdateCity = async () => {
    if (!editingCity || !newCity.city_name || !newCity.english_name) {
      alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    try {
      const response = await fetch(`/api/weather/cities/${editingCity.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          city_name: newCity.city_name,
          english_name: newCity.english_name
        })
      });

      if (response.ok) {
        const updatedCity = localCities.map(city => 
          city.id === editingCity.id 
            ? { ...city, city_name: newCity.city_name, english_name: newCity.english_name }
            : city
        );
        setLocalCities(updatedCity);
        setEditingCity(null);
        setNewCity({ city_code: '', city_name: '', english_name: '' });
        await fetchCities(); // DBÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
      }
    } catch (error) {
      console.error('ÎèÑÏãú ÏàòÏ†ï Ïã§Ìå®:', error);
      alert('ÎèÑÏãú ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  const handleDeleteCity = async (cityId: number) => {
    if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ ÎèÑÏãúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

    try {
      const response = await fetch(`/api/weather/cities/${cityId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        const updatedCities = localCities.filter(city => city.id !== cityId);
        setLocalCities(updatedCities);
        await fetchCities(); // DBÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
      }
    } catch (error) {
      console.error('ÎèÑÏãú ÏÇ≠Ï†ú Ïã§Ìå®:', error);
      alert('ÎèÑÏãú ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  const handleReorderCities = async (reorderedCities: WeatherCity[]) => {
    setLocalCities(reorderedCities);
    
    try {
      const citiesForReorder = reorderedCities.map((city, index) => ({
        id: city.id,
        display_order: index + 1
      }));

      await fetch('/api/weather/cities/reorder', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cities: citiesForReorder })
      });
    } catch (error) {
      console.error('ÎèÑÏãú ÏàúÏÑú Î≥ÄÍ≤Ω Ïã§Ìå®:', error);
      alert('ÎèÑÏãú ÏàúÏÑú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  const cancelEdit = () => {
    setEditingCity(null);
    setNewCity({ city_code: '', city_name: '', english_name: '' });
  };

  // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ ÏÑºÏÑú ÏÑ§Ï†ï
  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleDragEnd = (event: { active: { id: string }; over: { id: string } | null }) => {
    const { active, over } = event;

    if (active.id !== over.id) {
      const oldIndex = localCities.findIndex(city => city.id === active.id);
      const newIndex = localCities.findIndex(city => city.id === over.id);
      
      const reorderedCities = arrayMove(localCities, oldIndex, newIndex);
      handleReorderCities(reorderedCities);
    }
  };

  if (loading) {
    return (
      <Card className="bg-slate-800/50 border-slate-700">
        <CardHeader>
          <CardTitle className="text-white flex items-center gap-2">
          <Cloud className="h-5 w-5 text-yellow-300" />
          Ïò§ÎäòÏùò ÎÇ†Ïî®
        </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-center py-8 text-slate-300">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="bg-slate-800/50 border-slate-700">
      <Collapsible open={isOpen} onOpenChange={setIsOpen}>
        <CollapsibleTrigger asChild>
                   <CardHeader className="cursor-pointer hover:bg-slate-700/50 transition-colors">
                       <CardTitle className="text-yellow-300 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Cloud className="h-5 w-5 text-yellow-300" />
                <span>Ïò§ÎäòÏùò ÎÇ†Ïî®</span>
              </div>
              <div className="flex items-center gap-2">
               <button
                 onClick={(e) => {
                   e.stopPropagation();
                   fetchWeatherData(true);
                 }}
                 className="p-1 hover:bg-slate-600/50 rounded transition-colors disabled:opacity-50"
                 title="ÏÉàÎ°úÍ≥†Ïπ®"
                 disabled={refreshing}
               >
                 <RefreshCw size={16} className={`text-yellow-300 hover:text-yellow-200 ${refreshing ? 'animate-spin' : ''}`} />
               </button>
               {isOpen ? <ChevronUp size={20} className="text-yellow-300" /> : <ChevronDown size={20} className="text-yellow-300" />}
             </div>
           </CardTitle>
         </CardHeader>
        </CollapsibleTrigger>
        
        <CollapsibleContent>
          <CardContent className="space-y-4">
                         {/* ÎèÑÏãú ÏÑ†ÌÉù */}
             <div className="flex items-center justify-between p-3 bg-slate-700/30 rounded-lg">
               <div className="flex items-center gap-3">
                 <div className="flex items-center gap-2">
                   <MapPin size={16} className="text-slate-300" />
                   <span className="text-slate-300 text-sm">ÏßÄÏó≠ ÏÑ†ÌÉù:</span>
                 </div>
                 <select
                   value={selectedCity}
                   onChange={handleCityChange}
                   className="bg-slate-700 border border-slate-600 text-white text-sm rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                 >
                   {localCities.map((city) => (
                     <option key={city.city_code} value={city.city_code}>
                       {city.city_name}
                     </option>
                   ))}
                 </select>
               </div>
               <button
                 onClick={() => setIsDialogOpen(true)}
                 className="h-8 px-2 text-slate-300 hover:text-white hover:bg-slate-600/50 rounded transition-colors flex items-center"
                 title="ÏßÄÏó≠ ÏÑ§Ï†ï"
               >
                 <Settings size={16} className="mr-1" />
                 <span className="text-sm">ÏÑ§Ï†ï</span>
               </button>
             </div>

            {/* ÏÉàÎ°úÍ≥†Ïπ® Î©îÏãúÏßÄ */}
            {refreshMessage && refreshing && (
              <div className="p-4 bg-blue-900/30 border border-blue-700 rounded-lg">
                <div className="text-blue-300 text-sm text-center">
                  <RefreshCw size={16} className="inline animate-spin mr-2" />
                  {refreshMessage}
                </div>
              </div>
            )}

            {/* ÏóêÎü¨ Î©îÏãúÏßÄ */}
            {error && (
              <div className="p-4 bg-red-900/30 border border-red-700 rounded-lg">
                <div className="text-red-300 text-sm">
                  <strong>Ïò§Î•ò Î∞úÏÉù:</strong> {error}
                </div>
              </div>
            )}

            {/* ÎÇ†Ïî® Ï†ïÎ≥¥ */}
            {weatherData.length > 0 ? (
              <div className="grid grid-cols-4 gap-3">
                {weatherData.map((weather, idx) => (
                  <div key={idx} className="p-3 bg-slate-700/50 rounded-lg text-center">
                    <div className="text-slate-300 text-xs mb-2">
                      {formatTime(weather.time)}
                    </div>
                    <div className="text-3xl mb-2">
                      {getWeatherIcon(weather.icon)}
                    </div>
                    <div className="text-white font-semibold text-sm mb-1">
                      {Math.round(weather.temperature)}¬∞C
                    </div>
                    <div className="text-slate-400 text-xs">
                      ÏäµÎèÑ {weather.humidity}%
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-slate-400">
                {error ? 'ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.' : 'ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.'}
              </div>
            )}

                         {/* Ï†ïÎ≥¥ Ï∂úÏ≤ò */}
             <div className="mt-4 p-3 bg-slate-700/30 rounded-lg">
               <div className="text-center text-slate-300 text-sm">
                 <p>OpenWeatherMap APIÎ•º ÌÜµÌï¥ Ï†úÍ≥µÎêòÎäî ÎÇ†Ïî® Ï†ïÎ≥¥</p>
                 <p className="mt-1">3ÏãúÍ∞Ñ Îã®ÏúÑÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎäî ÏùºÍ∏∞ÏòàÎ≥¥ ‚Ä¢ {currentCityName} ÏßÄÏó≠</p>
               </div>
             </div>
           </CardContent>
         </CollapsibleContent>
       </Collapsible>

       {/* ÏßÄÏó≠ ÏÑ§Ï†ï Î™®Îã¨ */}
       {isDialogOpen && (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
           <div className="bg-slate-800 border border-slate-700 rounded-lg p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
             <div className="flex items-center justify-between mb-4">
               <h3 className="text-white text-lg font-semibold">ÏßÄÏó≠ ÏÑ§Ï†ï</h3>
               <button
                 onClick={handleDialogClose}
                 className="p-1 hover:bg-slate-700 rounded transition-colors"
               >
                 <X size={20} className="text-slate-300" />
               </button>
             </div>

             {/* ÏÉà ÏßÄÏó≠ Ï∂îÍ∞Ä/ÏàòÏ†ï Ìèº */}
             <div className="mb-6 p-4 bg-slate-700/30 rounded-lg">
               <h4 className="text-white text-sm font-medium mb-3">
                 {editingCity ? 'ÏßÄÏó≠ ÏàòÏ†ï' : 'ÏÉà ÏßÄÏó≠ Ï∂îÍ∞Ä'}
               </h4>
               <div className="space-y-3">
                 <div>
                   <label className="block text-slate-300 text-xs mb-1">ÎèÑÏãú ÏΩîÎìú</label>
                   <input
                     type="text"
                     value={newCity.city_code}
                     onChange={(e) => setNewCity({ ...newCity, city_code: e.target.value })}
                     disabled={!!editingCity}
                     className="w-full bg-slate-700 border border-slate-600 text-white text-sm rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50"
                     placeholder="Ïòà: Seoul"
                   />
                 </div>
                 <div>
                   <label className="block text-slate-300 text-xs mb-1">ÎèÑÏãúÎ™Ö (ÌïúÍ∏Ä)</label>
                   <input
                     type="text"
                     value={newCity.city_name}
                     onChange={(e) => setNewCity({ ...newCity, city_name: e.target.value })}
                     className="w-full bg-slate-700 border border-slate-600 text-white text-sm rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="Ïòà: ÏÑúÏö∏"
                   />
                 </div>
                 <div>
                   <label className="block text-slate-300 text-xs mb-1">ÎèÑÏãúÎ™Ö (ÏòÅÎ¨∏)</label>
                   <input
                     type="text"
                     value={newCity.english_name}
                     onChange={(e) => setNewCity({ ...newCity, english_name: e.target.value })}
                     className="w-full bg-slate-700 border border-slate-600 text-white text-sm rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="Ïòà: Seoul"
                   />
                 </div>
                 <div className="flex gap-2">
                   {editingCity ? (
                     <>
                       <button
                         onClick={handleUpdateCity}
                         className="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm py-2 px-4 rounded transition-colors"
                       >
                         ÏàòÏ†ï
                       </button>
                       <button
                         onClick={cancelEdit}
                         className="flex-1 bg-gray-600 hover:bg-gray-500 text-white text-sm py-2 px-4 rounded transition-colors"
                       >
                         Ï∑®ÏÜå
                       </button>
                     </>
                   ) : (
                     <button
                       onClick={handleAddCity}
                       className="w-full bg-green-600 hover:bg-green-500 text-white text-sm py-2 px-4 rounded transition-colors"
                     >
                       Ï∂îÍ∞Ä
                     </button>
                   )}
                 </div>
               </div>
             </div>

                           {/* ÏßÄÏó≠ Î™©Î°ù */}
              <div>
                <h4 className="text-white text-sm font-medium mb-3">ÏßÄÏó≠ Î™©Î°ù (ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏàúÏÑú Î≥ÄÍ≤Ω)</h4>
                <DndContext
                  sensors={sensors}
                  collisionDetection={closestCenter}
                  onDragEnd={handleDragEnd}
                >
                  <SortableContext
                    items={localCities.map(city => city.id)}
                    strategy={verticalListSortingStrategy}
                  >
                    <div className="space-y-2">
                      {localCities.map((city) => (
                        <SortableItem
                          key={city.id}
                          city={city}
                          onEdit={handleEditCity}
                          onDelete={handleDeleteCity}
                        />
                      ))}
                    </div>
                  </SortableContext>
                </DndContext>
              </div>
           </div>
         </div>
       )}
     </Card>
   );
 }
